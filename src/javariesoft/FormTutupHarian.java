/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package javariesoft;

import com.erv.db.KontrolTanggalDao;
import com.erv.db.koneksi;
import com.erv.function.Util;
import com.erv.model.Kontroltanggal;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;

/**
 *
 * @author TI-PNP
 */
public class FormTutupHarian extends javax.swing.JInternalFrame {

    /**
     * Creates new form FormTutupHarian
     */
    Connection c = null;

    public FormTutupHarian() {
        initComponents();
        try {
            c = koneksi.getKoneksiJ();
        } catch (SQLException ex) {
            Logger.getLogger(FormTutupHarian.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btnTutup = new javax.swing.JButton();
        jButton1 = new javax.swing.JButton();

        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(javariesoft.JavarieSoftApp.class).getContext().getResourceMap(FormTutupHarian.class);
        setTitle(resourceMap.getString("Form.title")); // NOI18N
        setName("Form"); // NOI18N
        addInternalFrameListener(new javax.swing.event.InternalFrameListener() {
            public void internalFrameActivated(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameDeactivated(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameDeiconified(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameIconified(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameClosed(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameClosing(javax.swing.event.InternalFrameEvent evt) {
                formInternalFrameClosing(evt);
            }
            public void internalFrameOpened(javax.swing.event.InternalFrameEvent evt) {
            }
        });
        getContentPane().setLayout(null);

        btnTutup.setFont(resourceMap.getFont("btnTutup.font")); // NOI18N
        btnTutup.setText(resourceMap.getString("btnTutup.text")); // NOI18N
        btnTutup.setName("btnTutup"); // NOI18N
        btnTutup.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTutupActionPerformed(evt);
            }
        });
        getContentPane().add(btnTutup);
        btnTutup.setBounds(30, 40, 200, 70);

        jButton1.setFont(resourceMap.getFont("jButton1.font")); // NOI18N
        jButton1.setText(resourceMap.getString("jButton1.text")); // NOI18N
        jButton1.setName("jButton1"); // NOI18N
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        getContentPane().add(jButton1);
        jButton1.setBounds(250, 40, 210, 70);

        setBounds(0, 0, 524, 170);
    }// </editor-fold>//GEN-END:initComponents

    private void btnTutupActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTutupActionPerformed
        try {
            // TODO add your handling code here:
            c.createStatement().execute("set autocommit false");
            prosesTutupHarian();
            c.commit();
        } catch (SQLException ex) {
            try {
                c.rollback();
                JOptionPane.showMessageDialog(this, "Rollback :"+ex.getMessage());
            } catch (SQLException ex1) {
                Logger.getLogger(FormTutupHarian.class.getName()).log(Level.SEVERE, null, ex1);
            }

        } finally {
            try {
                c.createStatement().execute("set autocommit true");
            } catch (SQLException ex) {
                Logger.getLogger(FormTutupHarian.class.getName()).log(Level.SEVERE, null, ex);
            }
        }
    }//GEN-LAST:event_btnTutupActionPerformed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:
        dispose();
    }//GEN-LAST:event_jButton1ActionPerformed

    private void formInternalFrameClosing(javax.swing.event.InternalFrameEvent evt) {//GEN-FIRST:event_formInternalFrameClosing
        try {
            // TODO add your handling code here:
            c.close();
        } catch (SQLException ex) {
            Logger.getLogger(FormTutupHarian.class.getName()).log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_formInternalFrameClosing


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnTutup;
    private javax.swing.JButton jButton1;
    // End of variables declaration//GEN-END:variables

    void prosesTutupHarian() throws SQLException {
        Util u = new Util();
        String tgl = u.thnsekarang + "-" + u.blnsekarang + "-" + u.tglsekarang;
//        Kontroltanggal kontroltanggal = KontrolTanggalDao.getKontroltanggals(c, tgl);
        Kontroltanggal kontroltanggal = KontrolTanggalDao.getKontroltanggalstatus(c);
        
        String tglPlus = "";

        if (kontroltanggal != null) {
            //String sqltglPlus = "select FORMATDATETIME(CURRENT_DATE() + 1,'yyyy-MM-dd') as tanggal";
            //String sqltglPlus = "select FORMATDATETIME('"+kontroltanggal.getTanggal()+"' + 1,'yyyy-MM-dd') as tanggal";
            String sqltglPlus = "select FORMATDATETIME(DATEADD('day', 1, DATE '"+kontroltanggal.getTanggal()+"'),'yyyy-MM-dd') as tanggal";
            kontroltanggal.setStatus(1);
            KontrolTanggalDao.updateKONTROLTANGGAL(c, kontroltanggal);
            ResultSet rs = c.createStatement().executeQuery(sqltglPlus);
            if (rs.next()) {
                tglPlus = rs.getString(1);
            }
            kontroltanggal.setTanggal(tglPlus);
            kontroltanggal.setStatus(0);
            KontrolTanggalDao.insertIntoKONTROLTANGGAL(c, kontroltanggal);
            JOptionPane.showMessageDialog(this, "Tutup Harian Ok");
        } else {
            JOptionPane.showMessageDialog(this, "Transaksi Tanggal Sekarang Belum di Buka");
        }
    }
}
